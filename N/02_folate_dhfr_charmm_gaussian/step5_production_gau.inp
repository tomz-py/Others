* GENERATED BY CHARMM-GUI (http://www.charmm-gui.org) v3.7 on Jun, 06. 2025. JOBID=4925720024
* INPUT FILE FOR NVT DYNAMICS OF SOLVATED GLOBULAR PROTEIN
*

DIMENS CHSIZE 5000000 MAXRES 3000000

! Read topology and parameter files
stream toppar.str

read rtf  card append name qm_regroup.top
read para card append name qm_params.prm flex

bomlev -1
! Please set cnt on the command line like this: $charmm cnt=$cnt -i step5_production.inp -o step5_production_${cnt}.out
if @?cnt .eq. 0 stop  ! Error: missing value for cnt

! Read PSF
open read unit 10 card name step4.1_qmmm.psf
read psf  unit 10 card

! Read Coordinate
open read unit 10 card name step4.1_qmmm.crd
read coor unit 10 card

!
! Setup PBC (Periodic Boundary Condition)
!

stream step3_pbcsetup.str

!
! Image Setup
!

open read unit 10 card name crystal_image.str
CRYSTAL DEFINE @XTLtype @A @B @C @alpha @beta @gamma
CRYSTAL READ UNIT 10 CARD


!Image centering by residue
IMAGE BYRESID XCEN @xcen YCEN @ycen ZCEN @zcen sele resname TIP3 end
IMAGE BYRESID XCEN @xcen YCEN @ycen ZCEN @zcen sele segid IONS end

!
! Nonbonded Options
!

NBONds -
   NBXMod 5 E14Fac 1.0 WMIN 1.0 -
   ELEC GROUp SWITch EWALd KAPPa 0.34 SPLIne PMEWald ORDEr 6 -
   FFTX 64 FFTY 64 FFTZ 64 -
   CDIE EPS 1.0 -
   VDW VGROup VSWItch -
   CUTNb 16.0 CTOFnb 12.0 CTONnb 10.0 INBF -1 IMGFrq -1 CUTIm 16.0

!
!use a restraint to place center of mass of the molecules near the origin
!

MMFP
GEO rcm sphere -
    Xref @xcen Yref @ycen Zref @zcen XDIR 1.0 YDIR 1.0 ZDIR 1.0 -
    harmonic FORCE 1.0 select .not. ( hydrogen .or. resname TIP3 .or. segid IONS ) end
END


!
!Umbrella Sampling Specifications
!

open write formatted unit 51 name rstcv_win_@{mdwin}_cnt_@{mdcnt}_rc_@{mdrc}_k_@{mdkumb}_charmm_gau.cv
open write formatted unit 52 name stat_win_@{mdwin}_cnt_@{mdcnt}_rc_@{mdrc}_k_@{mdkumb}_charmm_gau.stat

rxncor: define A1 point select atom HETD 1 C19 end !point
rxncor: define A2 point select atom HETD 1 H24 end !point
rxncor: define A3 point select atom HETB 1  C4 end !point
rxncor: define d12 distance A1 A2 !distance
rxncor: define d23 distance A2 A3 !distance

rxncor: define mycv combi d12 1.0 d23 -1.0  !! 'mycv' is r(C19(D)-H24(D)) - r(H24(D)-C4(B))
rxncor: set nrxn 1  mycv
rxncor: trace mycv unit 51
rxncor: umbrella name mycv form 1 kumb @mdkumb del0 @mdrc

calc ld @mdrc - 0.5
calc rd @mdrc + 0.5
rxncor: stat name mycv lowdelta @ld hidelta @rd deldel 0.01  start 0


!
! NVT dynamics:
! you can change
! nstep  : number of MD steps
! nprint : print-out frequency
! nsavc  : the trajectory saving frequency
!
scalar mass stat
calc Pmass = int ( ?stot  /  50.0 )


set temp = 300
set qmpackage = mndo97
stream qm_region.str
faster 2
shake bonh sele .not. ( QMS .or. type QQH* ) end param fast


! below "remove" command is to remove the force field/MM energies within qm regions,
! since we use qm for the interactions and energies for qm atom pairs.
if @qmpackage .eq. squantum then
   if ?squantum .eq. 1 then
      quantum sele ( QMS .or. type QQH* ) end AM1 charge 1 remove
   else
      stop
   endif
endif

if @qmpackage .eq. mndo97 then
   if ?mndo97 .eq. 1 then
      mndo97 sele ( QMS .or. type QQH* ) end AM1 charge 1 remove
   else
      stop
   endif
endif

if @qmpackage .eq. g09 then
   if ?g09 .eq. 1 then
      gaussian nogu remove sele ( QMS .or. type QQH* ) end
      ENVI g09exe       "g09"                            ! path to g09exe
      ENVI g09fchk      "formchk"                        ! path to chktool
      ENVI g09cmd       "G09CMD"                         ! file that provides the calculation parameters
      ENVI G09PROFILE   "G09PROFILE"                     ! a dummy empty file is required even if the G09PROFILE functionality is not utilized
      ENVI G09INP       "g1"                             ! input filename for file-based interfacing
      ENVI GAUSS_SCRDIR "/scratch/axa5186/guass_scratch" ! Make sure the scratch directory exists
   else
      stop
   endif
endif



energy


if @{mdqrst} .eq. 0 then
   open write unit 10 card name @{mdistep}_mini.pdb
   write coor unit 10 pdb
*title
* 

   close unit 10

   ! Short minimization
   mini abnr nstep 100

   open write unit 10 card name @{mdistep}_mini.pdb
   write coor unit 10 pdb
*title
* 

   close unit 10
endif


if @{mdqrst} .eq. 0 then
   set mdst start
   set iread -11
endif


if @{mdqrst} .eq. 1 then
   set mdst restart
   set iread 11
   open read  unit 11 card name @{mdpstep}.rst
endif

open write unit 12 card name @{mdistep}.rst
open write unit 13 file name @{mdistep}.dcd

dynamics leap cpt @{mdst} -
         nstep 5000 timestep 0.001 -
         iunrea @{iread} iunwri 12 iuncrd 13 iunvel -1 kunit -1 -
         nprint 10 nsavc 10 isvfrq 10 ntrf 10 ixtfrq 10 iprfrq 10 -
         firstt @temp finalt @temp tstruc @temp -
         teminc 0.00 ihtfrq 0 ieqfrq 0 iasor 0 iasvel 1 iscvel 0 -
         ichecw 0 twindh 5.0 twindl -5.0  -
         hoover tmass 1000.0 reft @temp -
         pconstant pinternal pmass @Pmass preferencce 1.0 ECHECK 1000000.0


!!Print Umbrella Sampling Binned Stat
rxncor: write unit 52
close unit 52

open write unit 10 card name @{mdistep}.pdb
write coor unit 10 pdb
*title
*

close unit 10

open write unit 10 card name @{mdistep}.crd
write coor unit 10 card
*title
*

close unit 10

stop
